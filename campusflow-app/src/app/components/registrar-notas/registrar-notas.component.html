<div class="registro-notas-profesor-container">
  <h2>Registro de Notas del Profesor</h2>

  <div class="selection-area">
    <div class="form-group" *ngIf="carreras.length > 0 && profesorCarreraId === null">
      <label for="carreraSelect">Seleccionar Carrera:</label>
      <select id="carreraSelect" [(ngModel)]="selectedCarreraId" (change)="onCarreraSelected()" [ngModelOptions]="{standalone: true}">
        <option [value]="null" disabled>-- Seleccione una carrera --</option>
        <option *ngFor="let carrera of carreras" [value]="carrera.idCarrera">{{ carrera.nombre }}</option>
      </select>
    </div>
    <div class="info-message" *ngIf="profesorCarreraId !== null">
      Profesor asignado a la carrera: <strong>{{ carreras.find(c => c.idCarrera === profesorCarreraId)?.nombre || 'Cargando...' }}</strong>
    </div>

    <div class="form-group">
      <label for="estudianteSelect">Seleccionar Estudiante:</label>
      <select id="estudianteSelect" formControlName="id_estudiante" [formGroup]="notaForm"
              [disabled]="(selectedCarreraId === null && profesorCarreraId === null) || estudiantes.length === 0 || isLoading">
        <option [value]="null" disabled>-- Seleccione un estudiante --</option>
        <option *ngFor="let estudiante of estudiantes" [value]="estudiante.IdEstudiante">
          {{ estudiante.nombre }} {{ estudiante.apellido }} (ID: {{ estudiante.IdEstudiante }})
        </option>
      </select>
      <div *ngIf="notaForm.get('id_estudiante')?.invalid && notaForm.get('id_estudiante')?.touched" class="error-message">
        Debe seleccionar un estudiante.
      </div>
      <div *ngIf="isLoading" class="loading-message">Cargando estudiantes...</div>
      <div *ngIf="!isLoading && estudiantes.length === 0 && (selectedCarreraId !== null || profesorCarreraId !== null)" class="info-message">
        No hay estudiantes disponibles para esta carrera.
      </div>
    </div>
  </div>

  <hr>

  <div class="nota-entry-form" [formGroup]="notaForm" *ngIf="selectedEstudiante">
    <h3>Registrar Nota para: <strong>{{ selectedEstudiante.nombre }} {{ selectedEstudiante.apellido }}</strong></h3>

    <div class="form-group">
      <label for="asignaturaSelect">Asignatura:</label>
      <select id="asignaturaSelect" formControlName="id_asignatura"
              [disabled]="asignaturasFiltradas.length === 0">
        <option [value]="null" disabled>-- Seleccione una asignatura --</option>
        <option *ngFor="let asig of asignaturasFiltradas" [value]="asig.id">{{ asig.nombre }}</option>
      </select>
      <div *ngIf="notaForm.get('id_asignatura')?.invalid && notaForm.get('id_asignatura')?.touched" class="error-message">
        Debe seleccionar una asignatura.
      </div>
      <div *ngIf="!asignaturasFiltradas.length && (selectedCarreraId !== null || profesorCarreraId !== null)" class="info-message">
        No hay asignaturas disponibles para la carrera seleccionada.
      </div>
    </div>

    <div class="form-group">
      <label for="tipoInput">Tipo de Nota:</label>
      <select id="tipoInput" formControlName="Tipo">
        <option value="" disabled>-- Seleccione un tipo --</option>
        <option *ngFor="let tipo of tiposNota" [value]="tipo">{{ tipo }}</option>
      </select>
      <div *ngIf="notaForm.get('Tipo')?.invalid && notaForm.get('Tipo')?.touched" class="error-message">
        El tipo de nota es requerido.
      </div>
    </div>

    <div class="form-group">
      <label for="puntajeInput">Puntaje (0-20):</label>
      <input type="number" id="puntajeInput" formControlName="Puntaje" min="0" max="20">
      <div *ngIf="notaForm.get('Puntaje')?.invalid && notaForm.get('Puntaje')?.touched" class="error-message">
        El puntaje es requerido y debe ser entre 0 y 20.
      </div>
    </div>

    <div class="form-group">
      <label for="pesoInput">Peso de la Nota (%):</label>
      <input type="number" id="pesoInput" formControlName="Peso_Nota" min="0" max="100">
      <div *ngIf="notaForm.get('Peso_Nota')?.invalid && notaForm.get('Peso_Nota')?.touched" class="error-message">
        El peso es requerido y debe ser entre 0 y 100.
      </div>
    </div>

    <div class="action-buttons">
      <button type="button" (click)="guardarNota()" [disabled]="notaForm.invalid || isLoading">
        <span *ngIf="!isLoading">Guardar Nota</span>
        <span *ngIf="isLoading">Guardando...</span>
      </button>
      <button type="button" (click)="resetForm()">Limpiar Formulario</button>
    </div>
  </div>

  <div *ngIf="errorMessage" class="alert error-alert">
    {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="alert success-alert">
    {{ successMessage }}
  </div>
</div>